# Log Correlation Guide for Security Monitoring

This document provides a comprehensive, technical, and field-ready guide to log correlation for your SIEM lab (Kali Linux + Wazuh + Custom Apps like Juice Shop). It explains concepts, event flows, correlation logic, detection engineering, and step-by-step practical execution.

---

## 1. Purpose of Log Correlation

Log correlation links multiple log events across systems, applications, services, and network layers to identify:

* Multi-stage attacks
* Lateral movement
* Privilege escalation
* Fraud or misuse patterns
* Abuse of legitimate credentials
* Indicators of compromise (IOCs)

Correlation converts **raw logs** → **contextual alerts** → **investigation insights**.

---

## 2. Lab Architecture (Reference)

For this lab, log events originate from:

* OWASP Juice Shop (application logs)
* Mutillidae / DVWA / WebGoat (web attacks)
* Wazuh Agent (file integrity, commands, authentication)
* System logs (auth.log, syslog)
* Proxy logs (Burp Suite intercept history)

Your SIEM (Wazuh Dashboard / Kibana / OpenSearch Dashboards) receives all events.

---

## 3. Types of Logs Used for Correlation

### 3.1 Web Application Logs

Generated by your vulnerable apps:

* Failed logins
* SQL errors
* Unexpected input
* Suspicious parameters
* Privilege misuse

Example:

```
GET /rest/user/login?email=' OR '1'='1 HTTP/1.1
```

### 3.2 System Authentication Logs

```
/var/log/auth.log
/var/log/secure
```

Detect:

* Brute-force attempts
* Privilege escalation (su/sudo)

### 3.3 Wazuh Security Module Logs

Includes:

* File Integrity Monitoring (FIM)
* Command Execution
* Policy Violations
* Malware Scan Results

### 3.4 Network & Proxy Logs

From Burp Suite or browser activity.

---

## 4. Core Log Correlation Techniques

### 4.1 Rule-Based Correlation

If condition A AND condition B occur → generate alert.

Example:

* Repeated SQL injection errors
* AND user account lockouts

### 4.2 Temporal Correlation

Events happening within a defined time window.

Example:

* 10 failed logins in 3 minutes

### 4.3 Cross-Source Correlation

Link events from different systems.

Example:

* App login from IP → Same IP triggers SSH brute force → High-risk correlation.

### 4.4 Pattern-Based Correlation

Match sequences:

* Recon → Exploit → Lateral movement → Privilege escalation.

---

## 5. Practical Correlation Labs

Below are ready-to-run labs in your Kali environment.

---

## LAB 1: SQL Injection + Error Flood Correlation

### Objective

Detect correlated SQL injection attempts across:

* Juice Shop access logs
* Wazuh rules

### Steps

1. Start Juice Shop.
2. Attack from any browser:

```
' OR 1=1 --
```

3. Generate multiple attempts.
4. Check logs:

```
/opt/juice-shop/logs/*.log
```

5. Open Wazuh Dashboard → Security Events.
6. Correlate:

* Multiple SQL errors (Juice Shop)
* Matching Wazuh rules for injection

### Expected Outcome

A correlated alert showing repeated SQL injection attacks.

---

## LAB 2: XSS Attempt + Suspicious Cookies

### Objective

Correlate XSS payloads with session anomalies.

### Steps

1. Inject XSS in Juice Shop search field:

```
<script>alert(1)</script>
```

2. Capture request using Burp Suite.
3. Observe new cookies or unexpected headers.
4. Check Wazuh FIM for:

* Cookie changes
* Modified local browser profile

5. Correlate events.

### Expected Outcome

Linked logs showing XSS → Cookie manipulation attempts.

---

## LAB 3: Privilege Escalation + Suspicious Commands

### Objective

Detect correlation between privilege escalation and system commands.

### Steps

1. In Kali terminal:

```
sudo su
whoami
```

2. Generate some suspicious commands:

```
cat /etc/shadow
chmod 777 /etc/passwd
```

3. Wazuh agent should send events.
4. Correlate:

* sudo authentication
* high-risk command execution

### Expected Outcome

SIEM correlation rule linking escalation + malicious command sequence.

---

## LAB 4: Brute Force + Successful Login Sequence

### Objective

Identify successful login after multiple failures.

### Steps

1. Attempt incorrect Juice Shop logins.
2. After 10 attempts, log in correctly.
3. SIEM will correlate:

* Failed logins
* Successful login
* Same IP address

### Expected Outcome

Correlated alert: "Brute-force followed by successful login".

---

## LAB 5: Cross-System Attack Correlation

### Objective

Correlate web application attack + SSH brute force from same IP.

### Steps

1. Use Kali to brute force SSH target machine (lab VM or localhost if configured).
2. Meanwhile, attack Juice Shop.
3. SIEM correlates based on:

* Same attacker IP
* Two different attack surfaces.

### Expected Outcome

Multi-vector attack correlation mapped to a source IP.

---

## LAB 6: File Integrity Monitoring (FIM) + Configuration Tampering

### Objective

Detect configuration tampering after an attack.

### Steps

1. Modify a monitored file:

```
sudo nano /etc/hosts
```

2. Save changes.
3. SIEM will generate FIM events.
4. Correlate with previously detected attacks.

### Expected Outcome

Alert showing "System tampering following web exploitation attempts".

---

## 6. Building Correlation Policies

Below is a general structure for correlation policies.

```
IF
  multiple_web_injection_attempts AND
  privilege_escalation_events AND
  suspicious_file_modifications
WITHIN
  15 minutes
THEN
  trigger_alert("Possible compromise and persistence attempt")
```

---

## 7. Recommended Log Correlation Strategy

* Enable broad log collection
* Normalize logs using consistent parsers
* Correlate by IP, username, session ID, request ID
* Build progressive multi-stage attack chains
* Use baselines and behavior anomalies

---

## 8. Summary

This guide provides practical, technical, lab-validated steps to perform and understand log correlation in a real-world SIEM setup. Use this file together with:

* WAZUH_INSTALL.md
* DETECTION_RULES.md

to create a complete detection and monitoring lab inside your K
